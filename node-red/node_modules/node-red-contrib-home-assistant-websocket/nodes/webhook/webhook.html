<link rel="stylesheet" type="text/css" href="homeassistant/static/common.css" />
<script src="homeassistant/static/common.js"></script>
<script type="text/javascript">
  function generateId(length) {
    const possible =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    return Array.from(
      { length: length },
      () => possible[Math.floor(Math.random() * possible.length)]
    ).join("");
  }

  RED.nodes.registerType("ha-webhook", {
    category: "home_assistant",
    color: "#038FC7",
    outputs: 1,
    outputLabels: "",
    icon: "font-awesome/fa-external-link-square",
    paletteLabel: "webhook",
    label: function() {
      return this.name || `webhook`;
    },
    labelStyle: nodeVersion.labelStyle,
    defaults: {
      name: { value: "" },
      server: { value: "", type: "server", required: true },
      outputs: { value: 1 },
      webhookId: { value: generateId(32), required: true },
      payloadLocation: { value: "payload" },
      payloadLocationType: { value: "msg" },
      headersLocation: { value: "headers" },
      headersLocationType: { value: "none" }
    },
    oneditprepare: function() {
      const node = this;
      haServer.init(node, "#node-input-server");
      $webhookId = $("#node-input-webhookId");

      exposeNode.init(node);

      $("#copyId").on("click", function() {
        const ele = $webhookId[0];
        const id = ele.value;
        ele.value = `https://<ip>:<port>/api/webhook/${id}`;

        ele.select();
        ele.setSelectionRange(0, 99999);

        document.execCommand("copy");
        ele.value = id;
      });

      $("#refresh").on("click", function() {
        $webhookId.val(generateId(32));
      });

      const NoneType = { value: "none", label: "None", hasValue: false };
      $("#node-input-payloadLocation").typedInput({
        types: ["msg", "flow", "global", NoneType],
        typeField: "#node-input-payloadLocationType"
      });
      $("#node-input-headersLocation").typedInput({
        types: ["msg", "flow", "global", NoneType],
        typeField: "#node-input-headersLocationType"
      });
    }
  });
</script>

<script type="text/x-red" data-template-name="ha-webhook">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
    <input type="hidden" id="node-input-outputs"/>
  </div>

  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
    <input type="text" id="node-input-server" />
  </div>

  <div class="form-row">
    <label for="node-input-webhookId"><i class="fa fa-cube"></i> ID</label>
    <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
      <div style="position: absolute; left: 0px; right: 80px;">
        <input type="text" id="node-input-webhookId" style="width: 100%" >
      </div>
      <a id="copyId" class="editor-button" style="position: absolute; right: 0px; top: 0px;"><i class="fa fa-copy"></i></a>
      <a id="refresh" class="editor-button" style="position: absolute; right: 40px; top: 0px;"><i class="fa fa-refresh"></i></a>
    </div>
  </div>

  <div class="form-row" id="payloadLocation">
    <label for="node-input-payloadLocation">Payload</label>
    <input type="hidden" id="node-input-payloadLocationType" />
    <input type="text" id="node-input-payloadLocation" style="width: 70%"/>
  </div>

  <div class="form-row" id="headersLocation">
    <label for="node-input-headersLocation">Headers</label>
    <input type="hidden" id="node-input-headersLocationType" />
    <input type="text" id="node-input-headersLocation"  style="width: 70%"/>
  </div>
</script>

<script type="text/x-red" data-help-name="ha-webhook">
  <p>Creates a webhook in Home Assistant where the request will be passed to this node.</p>
  <p>This nodes requires <a href="https://github.com/zachowj/hass-node-red" target="_blank">Node-RED custom integration <i class="fa fa-external-link external-link"></i></a> to be installed in Home Assistant</p>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>ID<span class="property-type">string</span></dt>
    <dd>A string to be used for the webhook URL in Home Assistant.</dd>

    <dt>Payload<span class="property-type">string</span></dt>
    <dd>Customizable location for the webhook payload. Defaults to msg.payload</dd>

    <dt>Headers<span class="property-type">number</span></dt>
    <dd>Customizable location for the webhook request headers.</dd>
  </dl>

  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>topic<span class="property-type">string</span></dt>
    <dd>webhook ID</dd>

    <dt>payload<span class="property-type">object | number | string</span></dt>
    <dd>The parsed body from the webhook request.</dd>
  </dl>
</script>
