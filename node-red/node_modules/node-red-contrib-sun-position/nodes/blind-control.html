<!DOCTYPE HTML>

<script type="text/javascript">
    (function() {
        /**
         * get a value
         * @param {*} node - the node representation
         * @param {string} name - name of the value
         * @returns {*} the value of th element
         */
        function getVal(node,name) {
            const v = $('#node-input-' + name).val();
            if (v === undefined) {
                return node[name];
            }
            return v;
        }
        /**
         * count decimals
         * @param {number} value - a floating point number
         * @returns {number} number of decimals
         */
        function countDecimals(value) {
            return value === value>> 0 ? 0 : value.toString().split('.')[1].length || 0;
        }

        /**
         * get the min and maximum blind positions
         * @param {*} node - the node representation
         * @returns {object} object with property __min__ and __max__
         */
        function getMinMaxBlindPos(node) {
            let max = getVal(node, 'blindOpenPos');
            let min = getVal(node, 'blindClosedPos');
            if (max < min) {
                [min, max] = [max, min];
            }
            return { min, max };
        }

        /**
         * validates a blind position
         * @param {*} node - the node representation
         * @param {number} v - the blind position to validate
         * @returns {boolean} __true__ if the blind position is valid
         */
        function validateBlindPos(node, v) {
            const n = parseFloat(v);
            const inc = getVal(node, 'blindIncrement');
            const mm = getMinMaxBlindPos(node);

            return RED.validators.number(v) &&
                    (v !== '') &&
                    (n <= mm.max) &&
                    (n >= mm.min) &&
                    Number.isInteger(Number((n / inc).toFixed(countDecimals(inc) + 2)));
        }
        /**
         * save rules
         * @param {number} rules - output of the editableList
         * @returns {number} number of decimals
         */
        function saveRules(rules) {
            const result = [];
            if (rules) {
                rules.each(function (_i) {
                    const rule = $(this);
                    const data = JSON.parse(rule.data('ruleData'));
                    data.index= _i;
                    result.push(data);
                });
            }
            return result;
        }

        /**
         * clip a test to a maximum length
         * @param {string} v text to clip
         * @param {number} l length to clip the text
         */
        function clipValueLength(v, l) {
            l = l || 15;
            v = String(v);
            if (v.length > l) {
                return v.slice(0, (l - 3)) + '...';
            }
            return v;
        }

        /**
         * clip a test to a maximum length
         * @param {string} v text to clip
         * @param {number} l length to clip the text
         */
        function clipValueLengthRight(v, l) {
            l = l || 15;
            v = String(v);
            if (v.length > l) {
                return '...' + v.slice(-(l - 3));
            }
            return v;
        }

        /**
         * get the label for a typed input vlaue
         * @param {*} node - the node object for getting i18N Data (node._())
         * @param {string} t - the type of the value
         * @param {string} v - the value
         * @param {number} [offset] - a optional offset to the value
         * @param {number} [l] - the desired maximum length (default = 18)
         * @returns {string} the value clipped to the given length
         */
        function getValueLabel(node, t, v, l) { // eslint-disable-line complexity
            l = l || 30;
            const suffix = '';

            switch (t) {
                case 'levelFixed': {
                    if (!v) {
                        return '?%';
                    }
                    if (v.includes('open')) {
                        return node._('blind-control.typeOptions.100');
                    }
                    if (v.includes('closed')) {
                        return node._('blind-control.typeOptions.0');
                    }
                    return String(v);
                }
                case 'jsonata':
                    v = String(v);
                    if (v.length < l) { return v + suffix; }
                    return node._('node-red-contrib-sun-position/position-config:common.label.jsonata') + suffix;
                case 'json':
                    v = String(v);
                    if (v.length < l) { return  v + suffix; }
                    return node._('node-red-contrib-sun-position/position-config:common.label.json') + suffix;
                case 'bin':
                    return node._('node-red-contrib-sun-position/position-config:common.label.binary') + suffix;
                case 'date':
                    return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + suffix;
                case 'dateSpecific':
                    return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + '+' + suffix;
                case 'string':
                case 'str':
                case 'dayOfMonth':
                    if (v === '') { return node._('node-red-contrib-sun-position/position-config:common.label.blank') + suffix; }
                    return '"' + clipValueLength(v, l) + '"' + suffix;
                case 'num':
                    if (v === '') { return '0' + suffix; }
                    return String(v) + suffix;
                case 'bool':
                    if (v === '') { return 'false' + suffix; }
                    return String(v) + suffix;
                case 'msg':
                case 'env':
                    return t + '.' + clipValueLength(v, l) + suffix;
                case 'flow':
                case 'global': {
                    const result = RED.utils.parseContextKey(v);
                    // special for Homematic Devices
                    if (/^.+\[('|").{18,}('|")\].*$/.test(result.key)) {
                        result.key = result.key.replace(/^.+\[('|")/, '').replace(/('|")\].*$/, '');
                    }
                    return t + '.' + clipValueLengthRight(result.key, l) + suffix;
                }
                case 'pdsCalcData':
                    return `"${node._('node-red-contrib-sun-position/position-config:common.types.suncalc')}"${suffix}`;
                case 'pdsCalcPercent':
                    return `"${node._('node-red-contrib-sun-position/position-config:common.types.suninsky')}"${suffix}`;
                case 'pdmCalcData':
                    return `"${node._('node-red-contrib-sun-position/position-config:common.types.mooncalc')}"`;
                case 'pdmPhase':
                    return `"${node._('node-red-contrib-sun-position/position-config:common.types.moonPhase')}"`;
                case 'pdsTime': {
                    switch (v) {
                        case 'astronomicalDawn':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.astronomicalDawn'), l) + suffix;
                        case 'amateurDawn':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.amateurDawn'), l) + suffix;
                        case 'nauticalDawn':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.nauticalDawn'), l) + suffix;
                        case 'blueHourDawnStart':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.blueHourDawnStart'), l) + suffix;
                        case 'civilDawn':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.civilDawn'), l) + suffix;
                        case 'blueHourDawnEnd':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.blueHourDawnEnd'), l) + suffix;
                        case 'goldenHourDawnStart':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.goldenHourDawnStart'), l) + suffix;
                        case 'sunrise':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.sunrise'), l) + suffix;
                        case 'sunriseEnd':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.sunriseEnd'), l) + suffix;
                        case 'goldenHourDawnEnd':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.goldenHourDawnEnd'), l) + suffix;
                        case 'solarNoon':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.solarNoon'), l) + suffix;
                        case 'goldenHourDuskStart':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.goldenHourDuskStart'), l) + suffix;
                        case 'sunsetStart':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.sunsetStart'), l) + suffix;
                        case 'sunset':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.sunset'), l) + suffix;
                        case 'goldenHourDuskEnd':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.goldenHourDuskEnd'), l) + suffix;
                        case 'blueHourDuskStart':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.blueHourDuskStart'), l) + suffix;
                        case 'civilDusk':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.civilDusk'), l) + suffix;
                        case 'blueHourDuskEnd':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.blueHourDuskEnd'), l) + suffix;
                        case 'nauticalDusk':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.nauticalDusk'), l) + suffix;
                        case 'amateurDusk':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.amateurDusk'), l) + suffix;
                        case 'astronomicalDusk':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.astronomicalDusk'), l) + suffix;
                        case 'nadir':
                            return clipValueLength(node._('node-red-contrib-sun-position/position-config:common.typeOptions.nadir'), l) + suffix;
                        default: {
                            const res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('amateur', 'amat-').replace('blueHour', 'blueHr-').replace('goldenHour', 'goldHr-');
                            return clipValueLength(res, l) + suffix;
                        }
                    }
                }
                case 'pdmTime':
                    switch (v) {
                        case 'rise':
                            return node._('node-red-contrib-sun-position/position-config:common.typeOptions.moonRise', 'rise') + suffix;
                        case 'set':
                            return node._('node-red-contrib-sun-position/position-config:common.typeOptions.moonSet', 'set') + suffix;
                        default:
                            return 'moon' + v + suffix;
                    }
                case 'pdsTimeNow':
                    return node._('node-red-contrib-sun-position/position-config:common.label.suntimeObj') + suffix;
                case 'PlT':
                    return node._('node-red-contrib-sun-position/position-config:common.typeOptions.PlTRes',{topic: clipValueLength(v, l), suffix} );
                case 'msgPayload':
                    return 'msg.payload';
                case 'msgTs':
                    return 'msg.ts';
                case 'msgLc':
                    return 'msg.lc';
                case 'msgValue':
                    return 'msg.value';
                case 'input':
                    return 'input data';
                case 'timespan':
                    return 'timespan';
                case 'operand1':
                    return 'operand1 data';
                case 'operand2':
                    return 'operand2 data';
                default: {
                    if (v === '') {
                        return node._('node-red-contrib-sun-position/position-config:common.label.blank');
                    }
                    return clipValueLength(v, l) + suffix;
                }
            }
        }

        /**
         * get a time in millisecond as string of the format hh:mm, hh:mm:ss or hh:mm:ss.mss
         * @param {number} s - milisecond
         * @returns {string} time as string
         */
        function msToTime(s) {
            // Pad to 2 or 3 digits, default is 2
            const pad = (n, z = 2) => ('00' + n).slice(-z);
            const sec = (s%6e4)/1000|0;
            const msec = s%1000;
            return pad(s/3.6e6|0) + ':' + pad((s%3.6e6)/6e4 | 0) + ((msec >0) ? (':' + pad(sec) +'.' + pad(msec, 3) ) : ((sec>0) ? ':' + pad(sec) : ''));
        }

        /**
         * get the time offset text
         */
        function _getOffsetText(node, t,v,m) {
            let result = '';
            if (t && t !== 'none') {
                if (t === 'num') {
                    const osmillis = v * m;
                    if (osmillis>0) {
                        result += ' + ' + msToTime(osmillis);
                    } else {
                        result += ' - ' +msToTime(osmillis * -1);
                    }
                } else {
                    result += ' offset <var>' + getValueLabel(node, t, v) + '</var>';
                    // result += ' * ' + data.multiplier/1000 + 's';
                }
            }
            return result;
        }
        /**
         * get a description of the rule rules
         * @param {object} data - a rule description
         * @returns {string} description of the rule
         */
        function getRuleDescription(node, selFields, data, enh) {
            let result = '';
            try {
                if (data.validOperandAType && data.validOperandAType !== 'none') {
                    result += '<div>';
                    result += '<i class="fa fa-code-fork" aria-hidden="true"></i> ';

                    result += '<var>' + getValueLabel(node, data.validOperandAType,data.validOperandAValue) + '</var>';
                    // result += node._('node-red-contrib-sun-position/position-config:common.comparatorDescription.' + data.validOperator);
                    result += ' ' + data.validOperatorText;
                    let operatorCount = 1;
                    const fields = selFields.comparator;
                    const fieldsLength = fields.length;
                    for (let index = 0; index < fieldsLength; index++) {
                        const el = fields[index];
                        if (el.id === data.validOperator) {
                            operatorCount = el.operatorCount;
                            break;
                        }
                    }

                    if (operatorCount > 1) {
                        result += ' ' + getValueLabel(node, data.validOperandBType, data.validOperandBValue);
                    }
                    if (data.valid2LogOperator > 0 && data.valid2OperandAType !== 'none') {
                        result += '<br/><strong>' + data.valid2LogOperatorText + '</strong> ';

                        result += '<var>' + getValueLabel(node, data.valid2OperandAType,data.valid2OperandAValue) + '</var>';
                        result += ' ' + data.valid2OperatorText;
                        let operatorCount = 1;
                        const fields = selFields.comparator;
                        const fieldsLength = fields.length;
                        for (let index = 0; index < fieldsLength; index++) {
                            const el = fields[index];
                            if (el.id === data.valid2Operator) {
                                operatorCount = el.operatorCount;
                                break;
                            }
                        }

                        if (operatorCount > 1) {
                            result += ' ' + getValueLabel(node, data.valid2OperandBType, data.valid2OperandBValue);
                        }
                    }
                    result += '</div>';
                }
                if (data.timeType && data.timeType !== 'none') {
                    result += '<div>';
                    result += '<i class="fa fa-clock-o" aria-hidden="true"></i> ';
                    result += data.timeOpText;
                    result += ' <var>' + getValueLabel(node, data.timeType, data.timeValue) + '</var>';
                    result += _getOffsetText(node, data.offsetType, data.offsetValue, data.multiplier);
                    if (enh && enh.timeReg) {
                        result += ' <i class="fa fa-hand-o-right indent-enh-text" aria-hidden="true"></i>&nbsp;<kbd>' + enh.timeReg.text + '</kbd>';
                    }

                    if (data.timeMinType && data.timeMinType !== 'none') {
                        result += '<div class="indent-time-text"><i class="fa fa-step-backward" aria-hidden="true"></i> <span>';
                        result += node._('blind-control.label.ruleTimeMin');
                        result += '</span> <var>';
                        result += getValueLabel(node, data.timeMinType, data.timeMinValue);
                        result += '</var>';
                        result += _getOffsetText(node, data.offsetMinType, data.offsetMinValue, data.multiplierMin);
                        if (enh && enh.timeMin) {
                            result += ' <i class="fa fa-hand-o-right indent-enh-text" aria-hidden="true"></i>&nbsp;<kbd>' + enh.timeMin.text + '</kbd>';
                        }
                        result += '</div>';
                    }
                    if (data.timeMaxType && data.timeMaxType !== 'none') {
                        result += '<div class="indent-time-text"><i class="fa fa-step-forward" aria-hidden="true"></i> <span>';
                        result += node._('blind-control.label.ruleTimeMax');
                        result += '</span> <var>';
                        result += getValueLabel(node, data.timeMaxType, data.timeMaxValue);
                        result += '</var>';
                        result += _getOffsetText(node, data.offsetMaxType, data.offsetMaxValue, data.multiplierMax);
                        if (enh && enh.timeMax) {
                            result += ' <i class="fa fa-hand-o-right indent-enh-text" aria-hidden="true"></i>&nbsp;<kbd>' + enh.timeMin.text + '</kbd>';
                        }
                        result += '</div>';
                    }
                    result += '</div>';
                }
                result += '<div>';
                if (typeof data.levelType !== 'undefined') {
                    if (data.levelType === 'levelND') {
                        if (data.levelOp === 1) {
                            result += node._('blind-control.label.ruleLevelResetMin');
                        } else if (data.levelOp === 2) {
                            result += node._('blind-control.label.ruleLevelResetMax');
                        } else {
                            result += node._('blind-control.label.ruleLevelND');
                        }
                    } else {
                        result += data.levelOpText;
                        result += ' <var>';
                        result += getValueLabel(node, data.levelType, data.levelValue);
                        result += '</var>';
                        // <meter value="2" min="0" max="10">2 out of 10</meter>
                    }
                } else {
                    result += '-';
                }

                result += '</div>';
            } catch (err) {
                console.log(err.message); // eslint-disable-line no-console
                console.log(err.stack); // eslint-disable-line no-console
                result = 'Error: "' + err.message + '"';
            }
            return result;
        }

        RED.nodes.registerType('blind-control', {
            category: 'advanced-input',
            color: '#FFCC66',
            icon: 'blind-white.png',
            inputs: 1,
            outputs: 1,
            defaults: {
                name: {
                    value: '',
                    required: false
                },
                topic: {
                    value: '',
                    required: false
                },
                positionConfig: {
                    value: '',
                    type: 'position-config',
                    required: true
                },
                outputs: { value: '1' },
                // #region blind settings
                blindIncrement: {
                    value: 0.01,
                    required: true,
                    validate(v) {
                        const n = parseFloat(v);
                        const mm = getMinMaxBlindPos(this);

                        return (RED.validators.number(v) &&
                                (n <= mm.max) &&
                                (n >= mm.min) );
                    }
                },
                blindOpenPos: {
                    value: 1.00,
                    required: true,
                    validate(v) {
                        const n = parseFloat(v);
                        return RED.validators.number(v) &&
                            (Number.isInteger(n / getVal(this, 'blindIncrement'))) &&
                            (n !== getVal(this, 'blindClosedPos'));
                    }
                },
                blindClosedPos: {
                    value: 0.00,
                    required: true,
                    validate(v) {
                        const n = parseFloat(v);
                        return RED.validators.number(v) &&
                                (Number.isInteger(n / getVal(this, 'blindIncrement'))) &&
                                (n !== getVal(this, 'blindOpenPos'));
                    }
                },
                blindPosReverse: {
                    value: false
                },
                blindPosDefault: {
                    value: 'open (max)',
                    validate: RED.validators.typedInput('blindPosDefaultType')
                },
                blindPosDefaultType: {
                    value: 'levelFixed'
                },
                // #endregion blind settings
                // #region overwrite settings
                overwriteExpire: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }
                },
                // #endregion overwrite settings
                // #region rule settings
                rules: {
                    value: {}
                },
                // #endregion time settings
                // #region sun settings
                sunControlMode: {
                    value: '0',
                    required: true,
                    validate(v) {
                        const n = Number(v);
                        return (RED.validators.number(v) && (n >= 0) && (n <= 2));
                    }
                },
                sunFloorLength: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 1) ||
                                (v === '') ||
                                (v !== '' && RED.validators.number(v));
                    }
                },
                sunMinAltitude: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        return (Number(getVal(this, 'sunControlMode')) <= 1) ||
                                (v === '') ||
                                (RED.validators.number(v) && (n >= 0) && (n <= 90));
                    }
                },
                sunMinDelta: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        const mm = getMinMaxBlindPos(this);
                        return ((Number(getVal(this, 'sunControlMode')) <= 1) ||
                                (v === '') ||
                                (n <= mm.max) &&
                                (n >= mm.min) &&
                                (n >= getVal(this, 'blindIncrement')) );
                    }
                },
                blindPosMin: {
                    value: 'closed (min)',
                    validate(v) {
                        return ((Number(getVal(this, 'sunControlMode')) <= 0) ||
                            RED.validators.typedInput('blindPosMinType')(v));
                    }
                },
                blindPosMinType: {
                    value: 'levelFixed'
                },
                blindPosMax: {
                    value: 'open (max)',
                    validate(v) {
                        return ((Number(getVal(this, 'sunControlMode')) <= 0) ||
                        RED.validators.typedInput('blindPosMaxType')(v));
                    }
                },
                blindPosMaxType: {
                    value: 'levelFixed'
                },
                smoothTime: {
                    value: '',
                    validate(v) {
                        const n = parseFloat(v);
                        return ((Number(getVal(this, 'sunControlMode')) <= 0) || (v === '') || (RED.validators.number(v) && (n > -2147483647) && (n < 0x7FFFFFFF)));
                    }
                },
                // #endregion sun settings
                // #region window settings
                windowTop: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                (v !== '' && RED.validators.number(v));
                    }
                },
                windowBottom: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                (v !== '' && RED.validators.number(v));
                    }
                },
                windowAzimuthStart: {
                    value: '',
                    validate(v) {
                        const n = Number(v);
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                (RED.validators.number(v) && (n >= -360) && (n <= 360) &&
                                (n < getVal(this, 'windowAzimuthEnd')) );
                    }
                },
                windowAzimuthEnd: {
                    value: '',
                    validate(v) {
                        const n = Number(v);
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                (RED.validators.number(v) && (n >= -360) && (n <= 360) &&
                                (n > getVal(this, 'windowAzimuthStart')) );
                    }
                },
                // #endregion window settings
                // #region oversteering settings
                oversteerValue: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                RED.validators.typedInput('oversteerValueType')(v);
                    }
                },
                oversteerValueType: {
                    value: 'none'
                },
                oversteerCompare: {
                    value: 'gte'
                },
                oversteerThreshold: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                (getVal(this, 'oversteerValueType') === 'none') ||
                                RED.validators.typedInput('oversteerThresholdType')(v);
                    }
                },
                oversteerThresholdType: {
                    value: 'num'
                },
                oversteerBlindPos: {
                    value: 'open (max)',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                                (getVal(this, 'oversteerValueType') === 'none') ||
                                RED.validators.typedInput('oversteerBlindPosType')(v); // validateBlindPos(this, v);
                    }
                },
                oversteerBlindPosType: {
                    value: 'levelFixed'
                },
                oversteer2Value: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            RED.validators.typedInput('oversteer2ValueType')(v);
                    }
                },
                oversteer2ValueType: {
                    value: 'none'
                },
                oversteer2Compare: {
                    value: 'gte'
                },
                oversteer2Threshold: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            (getVal(this, 'oversteer2ValueType') === 'none') ||
                            RED.validators.typedInput('oversteer2ThresholdType')(v);
                    }
                },
                oversteer2ThresholdType: {
                    value: 'num'
                },
                oversteer2BlindPos: {
                    value: 'open (max)',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            (getVal(this, 'oversteer2ValueType') === 'none') ||
                            RED.validators.typedInput('oversteer2BlindPosType')(v);
                    }
                },
                oversteer2BlindPosType: {
                    value: 'levelFixed'
                },
                oversteer3Value: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            (getVal(this, 'oversteer2ValueType') === 'none') ||
                            RED.validators.typedInput('oversteer3ValueType')(v);
                    }
                },
                oversteer3ValueType: {
                    value: 'none'
                },
                oversteer3Compare: {
                    value: 'gte'
                },
                oversteer3Threshold: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            (getVal(this, 'oversteer2ValueType') === 'none') ||
                            (getVal(this, 'oversteer3ValueType') === 'none') ||
                            RED.validators.typedInput('oversteer3ThresholdType')(v);
                    }
                },
                oversteer3ThresholdType: {
                    value: 'num'
                },
                oversteer3BlindPos: {
                    value: 'open (max)',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            (getVal(this, 'oversteer2ValueType') === 'none') ||
                            (getVal(this, 'oversteer3ValueType') === 'none') ||
                            RED.validators.typedInput('oversteer3BlindPosType')(v);
                    }
                },
                oversteer3BlindPosType: {
                    value: 'levelFixed'
                }
                // #endregion oversteering settings
            },
            outputLabels() {
                return [this._('blind-control.label.output1'), this._('blind-control.label.output2')];
            },
            label() {
                let suffix = '';
                if (this.rules && (this.rules.length >0)) {
                    suffix += '⏲';
                }
                if (Number(this.sunControlMode) === 2) {
                    suffix += '☀';
                } else if (Number(this.sunControlMode) === 1) {
                    suffix += '☃';
                }
                if (this.name) {
                    return this.name+' '+suffix;
                }
                const result = this._('blind-control.label.blind-control');
                if (this.topic && (this.topic.length + result.length <= 32)) {
                    return this.topic + ':' + result+' '+suffix;
                }
                return result+' '+suffix;
            },
            labelStyle() {
                return this.name ? 'node_label_italic' : '';
            },
            paletteLabel() { return this._('blind-control.label.blind-control-palette'); },
            oneditprepare() {
                setTimeout(() => {
                    $('.is-to-show-initially').show();
                    $('.is-to-hide-initially').hide();
                }, 300);
                $('.rdg-ui-btn').button();

                this.outputs = this.outputs || 1;
                this.sunControlMode = this.sunControlMode || 0;
                const $nodeConfig = $('#node-input-positionConfig');
                const node = this;

                // #region Dialog
                /**
                const $dialogCtx = $('#dialog-select-context').dialog({
                    autoOpen: false,
                    height: 400,
                    width: 600,
                    modal: true
                });
                /* */
                // #endregion Dialog

                const setup = function(node) {
                    /* global getTypes getSelectFields setupTInput appendOptions getBackendData bdDateToTime */
                    // #region initialize
                    const types = getTypes(node);
                    const selFields = getSelectFields();

                    types.LevelEntered = {
                        value: 'num',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelfree'),
                        icon: 'red/images/typedInput/09.png',
                        validate(v) { return validateBlindPos(this, v); }
                    };
                    types.LevelFix = {
                        value: 'levelFixed',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelfix'),
                        icon: 'icons/node-red-contrib-sun-position/inputTypeLevel.png',
                        options: [{
                            value: 'open (max)',
                            label: node._('blind-control.typeOptions.100')
                        }, {
                            value: '75%',
                            label: node._('blind-control.typeOptions.75')
                        }, {
                            value: '66%',
                            label: node._('blind-control.typeOptions.66')
                        }, {
                            value: '50%',
                            label: node._('blind-control.typeOptions.50')
                        }, {
                            value: '33%',
                            label: node._('blind-control.typeOptions.33')
                        }, {
                            value: '25%',
                            label: node._('blind-control.typeOptions.25')
                        }, {
                            value: '10%',
                            label: node._('blind-control.typeOptions.10')
                        }, {
                            value: 'closed (min)',
                            label: node._('blind-control.typeOptions.0')
                        }]
                    };
                    types.LevelND= {
                        value: 'levelND',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelND'),
                        icon: 'icons/node-red-contrib-sun-position/inputTypeNone2.png',
                        hasValue: false
                    };
                    /**
                     * save rules
                     * @param {*} node - the node representation
                     * @param {string} name - the node representation
                     * @param {*} element - the node representation
                     * @param {number} rules - output of the editableList
                     * @returns {number} number of decimals
                    */
                    function setMultiplier(node, name, element, validate, defMultiplier) {
                        const c = Number(node[name]);
                        if (node[name] !== '' && !isNaN(c)) {
                            let r = 1000;
                            if (c % 3600000 === 0) {
                                r = 3600000;
                            } else if (c % 60000 === 0) {
                                r = 60000;
                            }
                            $('#time-control-' + name).val(c/r);
                            $('#time-control-' + name + '-multiplier').val(r);
                        } else {
                            $('#time-control-' + name).val('');
                            $('#time-control-' + name + '-multiplier').val(defMultiplier || 1000);
                        }
                        $('#time-control-' + name).on('change focus focusout', () => {
                            const el = $('#time-control-' + name);
                            let val = el.val();
                            const mp = $('#time-control-' + name + '-multiplier').val();
                            if (isNaN(val) || val === '' || val === 0) {
                                val = '';
                                $('node-input-' + name).val('');
                            } else {
                                val = val * mp;
                                $('#node-input-' + name).val(val);
                            }

                            if (typeof validate === 'function') {
                                if (validate(val)) {
                                    el.removeClass( 'input-error' );
                                } else {
                                    el.addClass( 'input-error' );
                                }
                            }
                        });

                        $('#time-control-' + name + '-multiplier').change( () => {
                            $('#time-control-' + name).change();
                        });
                        $('#time-control-' + name).change();
                    }
                    /**
                     * get the default level
                     * @param {string} type - the type value
                     * @param {string} value - value
                     * @param {string} def - the default value
                     * @returns {string} the default value for the level
                    */
                    function getDefLevel(type, value, def) {
                        // console.log(`getDefLevel "${type}", "${value}", "${def}"`);
                        if (value) {
                            return value;
                        }
                        if (!type || type === types.LevelFix.value) {
                            return def;
                        }
                        return def;
                    }
                    // #endregion initialize
                    // #region blind
                    setMultiplier(node,'overwriteExpire', v => {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }, 3600000);
                    setupTInput(node, {
                        typeProp: 'blindPosDefaultType',
                        valueProp: 'blindPosDefault',
                        width: 'calc(100% - 110px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.blindPosDefaultType, node.blindPosDefault, 'open (max)'), // types.LevelFix.options[0],
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });

                    // #endregion blind
                    // #region rules

                    /**
                     * resizes a rule container
                     */
                    function resizeContainer() {
                        try {
                            const editorRow = $('.node-input-rule-container-row ol');
                            const height = editorRow.outerHeight(true);
                            const rows = $('#node-input-rule-container').editableList('items');
                            if (rows.size() > 0) {
                                $('#node-input-rule-container').editableList('height', height + 40);
                            } else {
                                $('#node-input-rule-container').editableList('height', 20);
                            }
                        } catch (ex) {
                            console.log(ex); // eslint-disable-line
                        }
                    }

                    $('#node-input-rule-container').css('min-height', '40px').css('min-width', '300px').editableList({
                        addItem($containerRow, containerIndex, data) {
                            if (data === {}) {
                                data.description = 'please edit rule';
                                data.name = 'empty';
                            }
                            data.index = containerIndex;
                            data.validOperandAType = (data.validOperandAType || types.Unlimited.value);
                            data.validOperandBType = (data.validOperandBType || 'num');
                            data.valid2LogOperator = (parseInt(data.valid2LogOperator) || 0);
                            data.valid2OperandAType = (data.valid2OperandAType || 'msg');
                            data.valid2OperandBType = (data.valid2OperandBType || 'num');
                            data.timeOp = (parseInt(data.timeOp) || 0);
                            data.timeType = (data.timeType || types.Undefined.value); // TimeEntered
                            data.timeValue = (data.timeValue || '');
                            data.offsetType = (data.offsetType || types.Undefined.value);
                            data.multiplier = (parseInt(data.multiplier) || 60000);

                            data.timeMinType = (data.timeMinType || types.Undefined.value);
                            data.timeMinValue = (data.timeMinValue || '');
                            data.timeMinOp = (parseInt(data.timeMinOp) || 0);
                            data.offsetMinType = (data.offsetMinType || types.Undefined.value);
                            data.multiplierMin = (parseInt(data.multiplierMin) || 60000);

                            data.timeMaxType = (data.timeMaxType || types.Undefined.value);
                            data.timeMaxValue = (data.timeMaxValue || '');
                            data.timeMaxOp = (parseInt(data.timeMaxOp) || 0);
                            data.offsetMaxType = (data.offsetMaxType || types.Undefined.value);
                            data.multiplierMax = (parseInt(data.multiplierMax) || 60000);

                            data.levelType = (data.levelType || types.LevelFix.value);
                            data.levelValue = (data.levelValue || 'closed (min)');
                            data.levelOp = (parseInt(data.levelOp) || 0);
                            if ((data.levelOp === 3) || (data.levelOp === 4)) {
                                data.levelType = types.LevelND.value;
                                data.levelValue = '';
                                data.levelOp = data.levelOp - 2;
                            }

                            data.levelOpText = data.levelOpText || node._('blind-control.label.ruleLevelAbs');
                            $containerRow.data('ruleData', JSON.stringify(data));
                            $containerRow.css({ overflow: 'hidden'}); // , whiteSpace: 'nowrap'
                            const $row0 = $('<div/>').appendTo($containerRow);
                            const $div = $('<div/>', {
                                class: 'blind-rule-mainblock'
                            }).appendTo($row0);
                            $('<span />', {
                                id: 'rule-name-'+containerIndex,
                                class: 'blind-rule-name-span'
                            }).append(data.name || 'rule ' + (containerIndex + 1)).appendTo( $div );
                            if (!data.description) {
                                data.description = getRuleDescription(node, selFields, data);
                            }
                            $('<div />', {
                                id: 'rule-description-'+containerIndex,
                                class: 'blind-rule-description-span'
                            }).append(data.description).appendTo( $div );
                            const finalspan1 = $('<span/>',{
                                class:'blind-rule-finalspan'
                            }).appendTo($row0);
                            finalspan1.append('<span class="node-input-rule-index">'+(containerIndex+1)+'</span> ');
                            const $btn = $('<a />', {
                                class: 'red-ui-button red-ui-button-small blind-rule-editBtn'
                            }).append('<i class= "fa fa-pencil-square-o" ></i>').appendTo($row0);
                            // $btn.button();
                            $btn.click(() => {
                                _dialogLoadData(containerIndex, $containerRow);
                            });
                        },
                        addButton: false,
                        sortable: true,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem(_opt) {
                            const rules = $('#node-input-rule-container').editableList('items');
                            rules.each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                            resizeContainer();
                        },
                        sortItems(_rules) {
                            const rules = $('#node-input-rule-container').editableList('items');
                            rules.each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                        }
                    });

                    // #region Button
                    const $btnAdd = $('#node-button-add');
                    $btnAdd.click(() => {
                        $('#node-input-rule-container').editableList('addItem', {});
                    });

                    const $btnClear = $('#node-button-clear');
                    $btnClear.click(() => {
                        $('#node-input-rule-container').editableList('empty');
                        resizeContainer();
                    });

                    const $btnSort = $('#node-button-sort');
                    $btnSort.click(() => {
                        const prerules = $('#node-input-rule-container').editableList('items');
                        prerules.each(function(i) {
                            const data = $(this).data('data');
                            data.index = i;
                            data.levelOp = (Number(data.levelOp) || 0);
                            data.conditional = ((data.validOperandAType !== 'none') ? 1 : 0);
                            data.timeLimited = ((data.timeType !== 'none') ? 1 : 0);
                            data.timeData = (parseFloat($(this).find('.node-input-rule-timeReg').attr('timedata')) || 0);
                            data.timeOp = (data.timeLimited) ? (Number(data.timeOp) || 0) : -1;
                        });
                        /**
                         * 1 no time
                         * 2 time    - until
                         * 3 time    - from
                         */
                        $('#node-input-rule-container').editableList('sort', (a, b) => {
                            const pos = (a.index - b.index);
                            if (!a.timeLimited && !b.timeLimited) { // both not time limited
                                return pos;
                            }
                            // both are time limited
                            const top = (a.timeOp - b.timeOp);
                            if (top !== 0) {
                                return top; // from before until; not timeLimited before timeLimited (1-3)
                            }
                            // both same from/until type
                            /*
                            if ((a.levelOp > 2) && (b.levelOp <= 2)) { // time is different
                                return 1; // a after b
                            } else if ((b.levelOp > 2) && (a.levelOp <= 2)) {
                                return -1; // a before b
                            } */

                            const time = a.timeData - b.timeData;
                            if ((a.timeData !== 0) && (b.timeData !== 0) && (time !== 0)) { // time is different
                                return time;
                            }
                            return pos;
                        });
                        const postrules = $('#node-input-rule-container').editableList('items');
                        postrules.each(function(i) {
                            $(this).find('.node-input-rule-index').html(i+1);
                            const data = $(this).data('data');
                            data.index = i;
                        });
                    });
                    // #endregion Button
                    // #endregion rules
                    // #region sun
                    $('#node-input-sunControlMode').on('change focus focusin focusout', (_type, _value) => {
                        const val= Number($('#node-input-sunControlMode').val());
                        if (val === 2) {
                            $('.form-row-sunControlActive').show();
                            $('.form-row-sunControlRestriction').show();
                            $('.form-row-sunControlMaximization').hide();
                        } else if (val === 1) {
                            $('.form-row-sunControlActive').show();
                            $('.form-row-sunControlRestriction').hide();
                            $('.form-row-sunControlMaximization').show();
                        } else {
                            $('.form-row-sunControlActive').hide();
                            $('.form-row-sunControlRestriction').hide();
                            $('.form-row-sunControlMaximization').hide();
                            $('.row-oversteerThreshold').hide();
                            $('.row-oversteerBlindPos').hide();
                            $('.row-oversteer2Value').hide();
                            $('.row-oversteer2Threshold').hide();
                            $('.row-oversteer2BlindPos').hide();
                            $('.row-oversteer3Value').hide();
                            $('.row-oversteer3Threshold').hide();
                            $('.row-oversteer3BlindPos').hide();
                        }
                        $('#node-input-oversteerValue').change();
                    });
                    // blindPosMin "undefined", "", blindPosMax "levelFixed", ""
                    // console.log(`blindPosMin "${node.blindPosMinType}", "${node.blindPosMin}", blindPosMax "${node.blindPosMaxType}", "${node.blindPosMax}"`);
                    setupTInput(node, {
                        typeProp: 'blindPosMinType',
                        valueProp: 'blindPosMin',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.blindPosMinType, node.blindPosMin, 'closed (min)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });
                    setupTInput(node, {
                        typeProp: 'blindPosMaxType',
                        valueProp: 'blindPosMax',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.blindPosMaxType, node.blindPosMax, 'open (max)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });

                    setMultiplier(node, 'smoothTime', v => {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number(v) && (n >= -2147483647) && (n < 0x7FFFFFFF));
                    }, 60000);
                    // #endregion sun
                    // #region oversteering
                    // #region oversteer - 1
                    setupTInput(node, {
                        typeProp: 'oversteerValueType',
                        valueProp: 'oversteerValue',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [types.Undefined, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon],
                        onChange(_type, _value) {
                            const sunControlMode = Number($('#node-input-sunControlMode').val());
                            const oversteerValueType = $('#node-input-oversteerValue').typedInput('type');
                            if ((oversteerValueType === types.Undefined.value) || (sunControlMode <= 0)) {
                                $('.row-oversteerBlindPos').hide();
                                $('#node-input-oversteerCompare').hide();
                                $('.row-oversteerThreshold').hide();
                                $('#node-input-oversteerValue').typedInput('width','calc(100% - 110px)');
                            } else if (oversteerValueType === 'jsonata' || oversteerValueType === types.PhaseMoon.value) {
                                $('.row-oversteerBlindPos').show();
                                $('#node-input-oversteerCompare').show();
                                $('#node-input-oversteerCompare').attr('disabled', true);
                                $('#node-input-oversteerCompare').val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('.row-oversteerThreshold').hide();
                                $('#node-input-oversteerValue').typedInput('width','calc(100% - 220px)');
                            } else {
                                $('.row-oversteerBlindPos').show();
                                $('#node-input-oversteerCompare').show();
                                $('#node-input-oversteerCompare').attr('disabled', false);
                                $('#node-input-oversteerValue').typedInput('width','calc(100% - 220px)');
                                const condOp = $('#node-input-oversteerCompare').val();
                                let operatorCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operatorCount = el.operatorCount;
                                        break;
                                    }
                                }
                                if (operatorCount > 1) {
                                    $('.row-oversteerThreshold').show(); // condOpB
                                } else {
                                    $('.row-oversteerThreshold').hide(); // condOpB
                                }
                            }
                            $('#node-input-oversteerThreshold').change();
                            $('#node-input-oversteerBlindPos').change();
                            $('#node-input-oversteer2Value').change();
                        }
                    });

                    const $oversteerCompare = $('#node-input-oversteerCompare');
                    appendOptions(node, $oversteerCompare, 'comparator');
                    $oversteerCompare.val(node.oversteerCompare || 'gte');
                    $oversteerCompare.change(() => { $('#node-input-oversteerValue').change(); });
                    setupTInput(node, {
                        typeProp: 'oversteerThresholdType',
                        valueProp: 'oversteerThreshold',
                        width: 'calc(100% - 120px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    setupTInput(node, {
                        typeProp: 'oversteerBlindPosType',
                        valueProp: 'oversteerBlindPos',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.oversteerBlindPosType, node.oversteerBlindPos, 'open (max)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });
                    // #endregion oversteer - 1
                    // #region oversteer - 2
                    setupTInput(node, {
                        typeProp: 'oversteer2ValueType',
                        valueProp: 'oversteer2Value',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [types.Undefined, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon],
                        onChange(_type, _value) {
                            const sunControlMode = Number($('#node-input-sunControlMode').val());
                            const oversteer1ValueType = $('#node-input-oversteerValue').typedInput('type');
                            const oversteer2ValueType = $('#node-input-oversteer2Value').typedInput('type');

                            if ((oversteer1ValueType === types.Undefined.value) || (sunControlMode <= 0)) {
                                // $('#node-input-oversteer2Value').typedInput('value','');
                                $('#node-input-oversteer2Value').typedInput('type', types.Undefined.value);
                                $('.row-oversteer2Value').hide();
                                $('.row-oversteer2Threshold').hide();
                                $('#node-input-oversteer2Compare').hide();
                                $('.row-oversteer2BlindPos').hide();
                            } else if (oversteer2ValueType === types.Undefined.value) {
                                $('.row-oversteer2Value').show();
                                $('.row-oversteer2BlindPos').hide();
                                $('#node-input-oversteer2Compare').hide();
                                $('.row-oversteer2Threshold').hide();
                                $('#node-input-oversteer2Value').typedInput('width', 'calc(100% - 110px)');
                            } else if (oversteer2ValueType === 'jsonata' || oversteer2ValueType === types.PhaseMoon.value) {
                                $('.row-oversteer2Value').show();
                                $('.row-oversteer2BlindPos').show();
                                $('#node-input-oversteer2Compare').show();
                                $('#node-input-oversteer2Compare').attr('disabled', true);
                                $('#node-input-oversteer2Compare').val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('.row-oversteer2Threshold').hide();
                                $('#node-input-oversteer2Value').typedInput('width', 'calc(100% - 220px)');
                            } else {
                                $('.row-oversteer2Value').show();
                                $('.row-oversteer2BlindPos').show();
                                $('#node-input-oversteer2Compare').show();
                                $('#node-input-oversteer2Compare').attr('disabled', false);
                                $('#node-input-oversteer2Value').typedInput('width', 'calc(100% - 220px)');
                                const condOp = $('#node-input-oversteer2Compare').val();
                                let operatorCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operatorCount = el.operatorCount;
                                        break;
                                    }
                                }
                                if (operatorCount > 1) {
                                    $('.row-oversteer2Threshold').show(); // condOpB
                                } else {
                                    $('.row-oversteer2Threshold').hide(); // condOpB
                                }
                            }
                            $('#node-input-oversteer2Threshold').change();
                            $('#node-input-oversteer2BlindPos').change();
                            $('#node-input-oversteer3Value').change();
                        }
                    });

                    const $oversteer2Compare = $('#node-input-oversteer2Compare');
                    appendOptions(node, $oversteer2Compare, 'comparator');
                    $oversteer2Compare.val(node.oversteer2Compare || 'gte');
                    $oversteer2Compare.change(() => { $('#node-input-oversteer2Value').change(); });
                    setupTInput(node, {
                        typeProp: 'oversteer2ThresholdType',
                        valueProp: 'oversteer2Threshold',
                        width: 'calc(100% - 120px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    setupTInput(node, {
                        typeProp: 'oversteer2BlindPosType',
                        valueProp: 'oversteer2BlindPos',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.oversteer2BlindPosType, node.oversteer2BlindPos, 'open (max)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });
                    // #endregion oversteer - 2
                    // #region oversteer - 3
                    setupTInput(node, {
                        typeProp: 'oversteer3ValueType',
                        valueProp: 'oversteer3Value',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [types.Undefined, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon],
                        onChange(_type, _value) {
                            const sunControlMode = Number($('#node-input-sunControlMode').val());
                            const oversteer2ValueType = $('#node-input-oversteer2Value').typedInput('type');
                            const oversteer3ValueType = $('#node-input-oversteer3Value').typedInput('type');

                            if ((oversteer2ValueType === types.Undefined.value) || (sunControlMode <= 0)) {
                                // $('#node-input-oversteer3Value').typedInput('value','');
                                $('#node-input-oversteer3Value').typedInput('type', types.Undefined.value);
                                $('.row-oversteer3Value').hide();
                                $('.row-oversteer3Threshold').hide();
                                $('#node-input-oversteer3Compare').hide();
                                $('.row-oversteer3BlindPos').hide();
                            } else if (oversteer3ValueType === types.Undefined.value) {
                                $('.row-oversteer3Value').show();
                                $('.row-oversteer3BlindPos').hide();
                                $('#node-input-oversteer3Compare').hide();
                                $('.row-oversteer3Threshold').hide();
                                $('#node-input-oversteer3Value').typedInput('width', 'calc(100% - 110px)');
                            } else if (oversteer3ValueType === 'jsonata' || oversteer3ValueType === types.PhaseMoon.value) {
                                $('.row-oversteer3Value').show();
                                $('.row-oversteer3BlindPos').show();
                                $('#node-input-oversteer3Compare').show();
                                $('#node-input-oversteer3Compare').attr('disabled', true);
                                $('#node-input-oversteer3Compare').val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('.row-oversteer3Threshold').hide();
                                $('#node-input-oversteer3Value').typedInput('width', 'calc(100% - 220px)');
                            } else {
                                $('.row-oversteer3Value').show();
                                $('.row-oversteer3BlindPos').show();
                                $('#node-input-oversteer3Compare').show();
                                $('#node-input-oversteer3Compare').attr('disabled', false);
                                $('#node-input-oversteer3Value').typedInput('width', 'calc(100% - 220px)');
                                const condOp = $('#node-input-oversteer3Compare').val();
                                let operatorCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operatorCount = el.operatorCount;
                                        break;
                                    }
                                }
                                if (operatorCount > 1) {
                                    $('.row-oversteer3Threshold').show(); // condOpB
                                } else {
                                    $('.row-oversteer3Threshold').hide(); // condOpB
                                }
                            }
                            $('#node-input-oversteer3Threshold').change();
                            $('#node-input-oversteer3BlindPos').change();
                        }
                    });

                    const $oversteer3Compare = $('#node-input-oversteer3Compare');
                    appendOptions(node, $oversteer3Compare, 'comparator');
                    $oversteer3Compare.val(node.oversteer3Compare || 'gte');
                    $oversteer3Compare.change(() => { $('#node-input-oversteer3Value').change(); });
                    setupTInput(node, {
                        typeProp: 'oversteer3ThresholdType',
                        valueProp: 'oversteer3Threshold',
                        width: 'calc(100% - 120px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    setupTInput(node, {
                        typeProp: 'oversteer3BlindPosType',
                        valueProp: 'oversteer3BlindPos',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.oversteer3BlindPosType, node.oversteer3BlindPos, 'open (max)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });
                    // #endregion oversteer - 3
                    // #endregion oversteering
                    // #region Enhanced settings
                    $('.spinner-noLimit').spinner();
                    $('.spinner-angle').spinner({
                        max: 360,
                        min: -360,
                        step: 1
                    });
                    $('.spinner-altitude').spinner({
                        max: 90,
                        min: 0,
                        step: 1
                    });
                    $('.spinner-level').spinner({
                        max: 100,
                        min: 0,
                        step: 0.01,
                        numberFormat: 'n'
                    });
                    $('.spinner-time').spinner({
                        max: 1439,
                        min: 0,
                        step: 1
                    });
                    // #endregion Enhanced settings
                    // fill rules
                    if (node.rules) {
                        for (let i = 0; i < node.rules.length; i++) {
                            const rule = node.rules[i];
                            // rule.index = i;
                            $('#node-input-rule-container').editableList('addItem', rule);
                        }
                        setTimeout(() => {
                            $('#node-input-sunControlMode').change();
                            resizeContainer();
                        }, 1500);
                    }

                    // #region dialog
                    const $dialog = $('#dialog-edit-rule').dialog({
                        title: node._('blind-control.label.dialogtitle'),
                        autoOpen: false,
                        resizable: true,
                        height: Math.min(900, $(window).height() * 0.8),
                        width: Math.min(850, $(window).width() * 0.8),
                        modal: true,
                        closeOnEscape: true,
                        classes : {
                            'ui-dialog': 'ui-dialog-rdg ',
                            'ui-dialog-content': 'ui-dialog-content-rdg ',
                            'ui-dialog-titlebar': 'ui-dialog-titlebar-rdg'
                        },
                        buttons: {
                            Ok() {
                                _dialogSaveData();
                                $dialog.dialog( 'close' );
                                $dialogDataRow = null;
                                dialogDataIndex = -1;
                            },
                            Cancel() {
                                $dialog.dialog( 'close' );
                                $dialogDataRow = null;
                                dialogDataIndex = -1;
                            }
                        }
                    });

                    const $dialogName = $dialog.find('#dlg-ip-blindctl-rule-name');
                    let $dialogDataRow = null;
                    let dialogDataOnLoading = false;
                    let dialogDataIndex = -1;
                    const dialogAddData = {};
                    /**
                     * Build the dialog
                     */
                    // #region dialogCond1
                    const $dialogCondAOperand = $dialog.find('#dlg-ip-blindctl-rule-condAOperand');
                    $dialogCondAOperand.typedInput({
                        default: types.Unlimited.value,
                        types: [types.Unlimited, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon, types.MsgPayloadByTopic]
                    });
                    $dialogCondAOperand.typedInput('width', '40%'); // calc(100% - 220px)

                    const $dialogCondAOperator = $dialog.find('#dlg-ip-blindctl-rule-condAOperator');
                    appendOptions(node, $dialogCondAOperator, 'comparator');
                    const $dialogCondBOperand = $dialog.find('#dlg-ip-blindctl-rule-condBOperand');
                    $dialogCondBOperand.typedInput({
                        default: 'num',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    $dialogCondBOperand.typedInput('width', '70%');
                    // #endregion dialogCond1
                    // #region dialogCond2
                    const $dialogCond2LogOperator = $dialog.find('#dlg-ip-blindctl-rule-cond2LogOperator');
                    $dialogCond2LogOperator.append($('<option></option>').val(0).text(node._('blind-control.label.ruleCondNone')));
                    $dialogCond2LogOperator.append($('<option></option>').val(1).text(node._('blind-control.label.ruleCondOr')));
                    $dialogCond2LogOperator.append($('<option></option>').val(2).text(node._('blind-control.label.ruleCondAnd')));

                    const $dialogCond2AOperand = $dialog.find('#dlg-ip-blindctl-rule-cond2AOperand');
                    $dialogCond2AOperand.typedInput({
                        default: 'msg',
                        types: ['msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon, types.MsgPayloadByTopic]
                    });
                    $dialogCond2AOperand.typedInput('width', '40%'); // calc(100% - 220px)

                    const $dialogCond2AOperator = $dialog.find('#dlg-ip-blindctl-rule-cond2AOperator');
                    appendOptions(node, $dialogCond2AOperator, 'comparator');
                    const $dialogCond2BOperand = $dialog.find('#dlg-ip-blindctl-rule-cond2BOperand');
                    $dialogCond2BOperand.typedInput({
                        default: 'num',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    $dialogCond2BOperand.typedInput('width', '70%');
                    // #endregion dialogCond2
                    // #region dialogTimeReg
                    const $dialogTimeRegOperator = $dialog.find('#dlg-ip-blindctl-rule-timeReg-operator');
                    $dialogTimeRegOperator.append($('<option></option>').val(0).text(node._('blind-control.label.ruleTimeUntil')));
                    $dialogTimeRegOperator.append($('<option></option>').val(1).text(node._('blind-control.label.ruleTimeFrom')));

                    const $dialogTimeRegInput = $dialog.find('#dlg-ip-blindctl-rule-timeReg');
                    $dialogTimeRegInput.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata']
                    });
                    $dialogTimeRegInput.typedInput('width', '40%');

                    const $dialogTimeRegOffset = $dialog.find('#dlg-ip-blindctl-rule-offset-timeReg');
                    $dialogTimeRegOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata']
                    }).change(() => { $dialogTimeRegInput.change(); });
                    $dialogTimeRegOffset.typedInput('width', '40%');

                    const $dialogTimeRegMultiplier = $dialog.find('#dlg-ip-blindctl-rule-multiplier-timeReg');
                    appendOptions(node, $dialogTimeRegMultiplier, 'multiplier', data => (data.id > 0));
                    // #endregion dialogTimeReg
                    // #region dialogTimeMin
                    const $dialogTimeMinInput = $dialog.find('#dlg-ip-blindctl-rule-timeMin');
                    $dialogTimeMinInput.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata']
                    });
                    $dialogTimeMinInput.typedInput('width', '40%');

                    const $dialogTimeMinOffset = $dialog.find('#dlg-ip-blindctl-rule-offset-timeMin');
                    $dialogTimeMinOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata']
                    }).change(() => { $dialogTimeMinInput.change(); });
                    $dialogTimeMinOffset.typedInput('width', '40%');

                    const $dialogTimeMinMultiplier = $dialog.find('#dlg-ip-blindctl-rule-multiplier-timeMin');
                    appendOptions(node, $dialogTimeMinMultiplier, 'multiplier', data => (data.id > 0));
                    // #endregion dialogTimeMin
                    // #region dialogTimeMax
                    const $dialogTimeMaxInput = $dialog.find('#dlg-ip-blindctl-rule-timeMax');
                    $dialogTimeMaxInput.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata']
                    });
                    $dialogTimeMaxInput.typedInput('width', '40%');

                    const $dialogTimeMaxOffset = $dialog.find('#dlg-ip-blindctl-rule-offset-timeMax');
                    $dialogTimeMaxOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata']
                    }).change(() => { $dialogTimeMaxInput.change(); });
                    $dialogTimeMaxOffset.typedInput('width', '40%');

                    const $dialogTimeMaxMultiplier = $dialog.find('#dlg-ip-blindctl-rule-multiplier-timeMax');
                    appendOptions(node, $dialogTimeMaxMultiplier, 'multiplier', data => (data.id > 0));
                    // #endregion dialogTimeMax
                    // #region dialogLevel
                    const $dialogLevel = $dialog.find('#dlg-ip-blindctl-rule-level');
                    $dialogLevel.typedInput({
                        default: types.LevelFix.value,
                        types: [types.LevelFix, types.LevelEntered, types.LevelND,'msg', 'flow', 'global', 'env']
                    });
                    $dialogLevel.typedInput('width', '40%');
                    const $dialogLevelOperator = $dialog.find('#dlg-ip-blindctl-rule-level-operator');
                    $dialogLevelOperator.append($('<option></option>').val(0).text(node._('blind-control.label.ruleLevelAbs')));
                    $dialogLevelOperator.append($('<option></option>').val(1).text(node._('blind-control.label.ruleLevelMin')));
                    $dialogLevelOperator.append($('<option></option>').val(2).text(node._('blind-control.label.ruleLevelMax')));
                    // #endregion dialogLevel
                    // #region dialogChange
                    $dialogTimeRegInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opType = $dialogTimeRegInput.typedInput('type');
                        if (opType === types.Undefined.value) {
                            dialogAddData.timeReg = {
                                ts : 0,
                                data : null,
                                text : 'N/A'
                            };
                            $('#dialog-row-timeReg').attr('title', dialogAddData.timeReg.text);
                            $dialogTimeRegInput.attr('timedata', dialogAddData.timeReg.ts);
                            $dialogTimeRegOperator.hide();
                            $('#dialog-row-offset-timeReg').hide();
                            $('#dialog-row-timeReg').attr('title', opType);

                            $('#dialog-row-timeMin').hide();
                            $('#dialog-row-timeMax').hide();
                            $('#dialog-row-offset-timeMin').hide();
                            $('#dialog-row-offset-timeMax').hide();
                            // $dialogTimeMinInput.typedInput('value','');
                            if ($dialogTimeMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeMaxInput.typedInput('type', types.Undefined.value);
                            }
                            // $dialogTimeMaxInput.typedInput('value','');
                            if ($dialogTimeMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeMaxInput.typedInput('type', types.Undefined.value);
                            }
                            _dialogGenHelpText();
                            return;
                        } else if (opType === types.TimeSun.value || opType === types.TimeMoon.value) {
                            $dialogTimeRegOperator.show();
                            $('#dialog-row-offset-timeReg').show();
                        } else {
                            $dialogTimeRegOperator.show();
                            $('#dialog-row-offset-timeReg').hide();
                        }
                        getBackendData(d => {
                            // console.log('getBackendData of $dialogTimeRegInput ',d);
                            if (d.value && d.value !== 'none') {
                                const dv = new Date(d.value);
                                dialogAddData.timeReg = {
                                    ts : dv.getTime(),
                                    data : d,
                                    text : bdDateToTime(dv)
                                };
                            } else {
                                dialogAddData.timeReg = {
                                    ts : 0,
                                    data : null,
                                    text : d.value
                                };
                            }
                            $('#dialog-row-timeReg').attr('title', dialogAddData.timeReg.text);
                            $dialogTimeRegInput.attr('timedata', dialogAddData.timeReg.ts);
                            _dialogGenHelpText();
                        }, {
                            nodeId:     node.id,
                            kind:       'getTimeData',
                            config:     $nodeConfig.val(),
                            type:       opType,
                            value:      $dialogTimeRegInput.typedInput('value'),
                            offsetType: $dialogTimeRegOffset.typedInput('type'),
                            offset:     $dialogTimeRegOffset.typedInput('value'),
                            multiplier: parseInt($dialogTimeRegMultiplier.val()),
                            noOffsetError: true
                        });
                        $dialogTimeMinInput.change();
                        $dialogTimeMaxInput.change();
                    });

                    $dialogTimeMinInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeMin').show();
                            const opType = $dialogTimeMinInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeMin').hide();
                                dialogAddData.timeMin = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeMin').attr('title', dialogAddData.timeMin.text);
                                $dialogTimeMinInput.attr('timedata', dialogAddData.timeMin.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeSun.value || opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeMin').show();
                            } else {
                                $('#dialog-row-offset-timeMin').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    dialogAddData.timeMin = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    dialogAddData.timeMin = {
                                        ts : 0,
                                        data : null,
                                        text : d.value
                                    };
                                }
                                $('#dialog-row-timeMin').attr('title', dialogAddData.timeMin.text);
                                $dialogTimeMinInput.attr('timedata', dialogAddData.timeMin.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId: node.id,
                                kind: 'getTimeData',
                                config: $nodeConfig.val(),
                                type: opType,
                                value: $dialogTimeMinInput.typedInput('value'),
                                offsetType: $dialogTimeMinOffset.typedInput('type'),
                                offset: $dialogTimeMinOffset.typedInput('value'),
                                multiplier: parseInt($dialogTimeMinMultiplier.val()),
                                noOffsetError: true
                            });
                        }
                    });

                    $dialogTimeMaxInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeMax').show();
                            const opType = $dialogTimeMaxInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeMax').hide();
                                dialogAddData.timeMax = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeMax').attr('title', dialogAddData.timeMax.text);
                                $dialogTimeMaxInput.attr('timedata', dialogAddData.timeMax.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeSun.value || opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeMax').show();
                            } else {
                                $('#dialog-row-offset-timeMax').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    dialogAddData.timeMax = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    dialogAddData.timeMax = {
                                        ts : 0,
                                        data : null,
                                        text : d.value
                                    };
                                }
                                $('#dialog-row-timeMax').attr('title', dialogAddData.timeMax.text);
                                $dialogTimeMaxInput.attr('timedata', dialogAddData.timeMax.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId: node.id,
                                kind: 'getTimeData',
                                config: $nodeConfig.val(),
                                type: opType,
                                value: $dialogTimeMaxInput.typedInput('value'),
                                offsetType: $dialogTimeMaxOffset.typedInput('type'),
                                offset: $dialogTimeMaxOffset.typedInput('value'),
                                multiplier: parseInt($dialogTimeMaxMultiplier.val()),
                                noOffsetError: true
                            });
                        }
                    });

                    $dialogCondAOperand.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const propType = $dialogCondAOperand.typedInput('type');
                        if (propType === 'none') {
                            $dialogCondAOperator.val(selFields.comparator[0].id);
                            $dialogCondAOperator.hide();
                            $('#dialog-row-condB').hide();

                            $dialogCond2LogOperator.val(0);
                            $('#dialog-row-cond2LogOperator').hide();
                        } else if (propType === 'jsonata' || propType === types.PhaseMoon.value) {
                            $dialogCondAOperator.show();
                            $dialogCondAOperator.attr('disabled', true);
                            $dialogCondAOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('#dialog-row-condB').hide();
                            $('#dialog-row-cond2LogOperator').show();
                        } else {
                            $dialogCondAOperator.show();
                            $dialogCondAOperator.attr('disabled', false);
                            const condOp = $dialogCondAOperator.val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('#dialog-row-condB').show();
                            } else {
                                $('#dialog-row-condB').hide();
                            }
                            $('#dialog-row-cond2LogOperator').show();
                        }
                        $dialogCondBOperand.change();
                        $dialogCond2AOperand.change();
                        _dialogGenHelpText();
                    });
                    $dialogCondAOperator.change(() => { $dialogCondAOperand.change(); });

                    $dialogCond2AOperand.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const op2 = parseInt($dialogCond2LogOperator.val());
                        if (isNaN(op2) || op2 === 0) {
                            $dialogCond2AOperator.val(selFields.comparator[0].id);
                            $dialogCond2AOperator.hide();
                            $('#dialog-row-cond2A').hide();
                            $('#dialog-row-cond2B').hide();
                        } else {
                            $dialogCond2AOperator.show();
                            $('#dialog-row-cond2A').show();
                            const propType = $dialogCond2AOperand.typedInput('type');
                            if (propType === 'none') {
                                $dialogCond2AOperator.val(selFields.comparator[0].id);
                                $dialogCond2AOperator.hide();
                                $('#dialog-row-cond2B').hide();
                            } else if (propType === 'jsonata' || propType === types.PhaseMoon.value) {
                                $dialogCond2AOperator.show();
                                $dialogCond2AOperator.attr('disabled', true);
                                $dialogCond2AOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('#dialog-row-cond2B').hide();
                            } else {
                                $dialogCond2AOperator.show();
                                $dialogCond2AOperator.attr('disabled', false);
                                const condOp = $dialogCond2AOperator.val();
                                let operatorCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operatorCount = el.operatorCount;
                                        break;
                                    }
                                }
                                if (operatorCount > 1) {
                                    $('#dialog-row-cond2B').show();
                                } else {
                                    $('#dialog-row-cond2B').hide();
                                }

                            }
                        }
                        $dialogCond2BOperand.change();
                        _dialogGenHelpText();
                    });
                    $dialogCond2LogOperator.change(() => { $dialogCond2AOperand.change(); });
                    $dialogCond2AOperator.change(() => { $dialogCond2AOperand.change(); });
                    // #endregion dialogChange
                    // #region dialogload & save
                    /**
                     * set Data for typed input
                     */
                    function setTI($field, value, type) {
                        // $field.typedInput('value', value);
                        if (type === 'flow' || type === 'global') {
                            $field.typedInput('type', 'env'); // env haben alle, bug fix
                            $field.typedInput('value', value);
                            $field.typedInput('type', type);
                        } else {
                            $field.typedInput('type', type);
                            $field.typedInput('value', value);
                        }
                        // $field.typedInput('type', type);
                    }

                    /**
                     * generates the help text of the dialog
                     */
                    function _dialogGenHelpText() {
                        $('#dlg-txt-blindctl-rule-descr').html('');
                        if (dialogAddData.timeout) {
                            clearTimeout(dialogAddData.timeout);
                            dialogAddData.timeout = null;
                        }
                        dialogAddData.timeout = setTimeout(() => {
                            dialogAddData.timeout = null;
                            $('#dlg-txt-blindctl-rule-descr').html(getRuleDescription(node, selFields, _dialogGetData(), dialogAddData));
                        },1000);
                    }
                    /**
                     * load the data from the rule
                     */
                    function _dialogLoadData(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            $dialogName.val(data.name);
                            dialogDataOnLoading = true;

                            $dialogCondAOperator.val(data.validOperator || selFields.comparator[0].id);
                            setTI($dialogCondAOperand, data.validOperandAValue, data.validOperandAType);
                            setTI($dialogCondBOperand, data.validOperandBValue, data.validOperandBType);

                            $dialogCond2LogOperator.val(data.valid2LogOperator || 0);
                            $dialogCond2AOperator.val(data.valid2Operator || selFields.comparator[0].id);
                            setTI($dialogCond2AOperand, data.valid2OperandAValue, data.valid2OperandAType);
                            setTI($dialogCond2BOperand, data.valid2OperandBValue, data.valid2OperandBType);

                            $dialogTimeRegOperator.val(data.timeOp || 0);
                            $dialogTimeRegMultiplier.val(data.multiplier || 60000);
                            setTI($dialogTimeRegInput, data.timeValue, data.timeType);
                            setTI($dialogTimeRegOffset, data.offsetValue, data.offsetType);

                            $dialogTimeMinMultiplier.val(data.multiplierMin || 60000);
                            setTI($dialogTimeMinInput, data.timeMinValue, data.timeMinType);
                            setTI($dialogTimeMinOffset, data.offsetMinValue, data.offsetMinType);

                            $dialogTimeMaxMultiplier.val(data.multiplierMax || 60000);
                            setTI($dialogTimeMaxInput, data.timeMaxValue, data.timeMaxType);
                            setTI($dialogTimeMaxOffset, data.offsetMaxValue, data.offsetMaxType);

                            $dialogLevelOperator.val(data.levelOp || 0);
                            setTI($dialogLevel, data.levelValue, data.levelType);
                            $dialogLevel.typedInput('value',data.levelValue);
                            $dialogLevel.typedInput('type',data.levelType);
                            _dialogGenHelpText();

                            dialogDataOnLoading = false;
                            $dialogCondAOperand.change();
                            $dialogTimeRegInput.change();
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            $dialogName.val(err.message);
                        }
                        $dialog.dialog('open');
                    }

                    /**
                     * Get the data object for a rule
                     */
                    function _dialogGetData() {
                        return {
                            index: dialogDataIndex,
                            name:$dialogName.val(),

                            timeValue: $dialogTimeRegInput.typedInput('value'),
                            timeType: $dialogTimeRegInput.typedInput('type'),
                            timeOp: parseInt($dialogTimeRegOperator.val()),
                            timeOpText: $dialogTimeRegOperator.find('option:selected').text(),
                            offsetValue: $dialogTimeRegOffset.typedInput('value'),
                            offsetType: $dialogTimeRegOffset.typedInput('type'),
                            multiplier:   parseInt($dialogTimeRegMultiplier.val()),

                            timeMinValue: $dialogTimeMinInput.typedInput('value'),
                            timeMinType: $dialogTimeMinInput.typedInput('type'),
                            offsetMinValue: $dialogTimeMinOffset.typedInput('value'),
                            offsetMinType: $dialogTimeMinOffset.typedInput('type'),
                            multiplierMin:  parseInt($dialogTimeMinMultiplier.val()),

                            timeMaxValue: $dialogTimeMaxInput.typedInput('value'),
                            timeMaxType: $dialogTimeMaxInput.typedInput('type'),
                            offsetMaxValue: $dialogTimeMaxOffset.typedInput('value'),
                            offsetMaxType: $dialogTimeMaxOffset.typedInput('type'),
                            multiplierMax:  parseInt($dialogTimeMaxMultiplier.val()),

                            levelValue: $dialogLevel.typedInput('value'),
                            levelType: $dialogLevel.typedInput('type'),
                            levelOp: parseInt($dialogLevelOperator.val()),
                            levelOpText: $dialogLevelOperator.find('option:selected').text(),

                            validOperandAValue: $dialogCondAOperand.typedInput('value'),
                            validOperandAType: $dialogCondAOperand.typedInput('type'),
                            validOperator: $dialogCondAOperator.val(),
                            validOperatorText: $dialogCondAOperator.find('option:selected').text(),
                            validOperandBValue: $dialogCondBOperand.typedInput('value'),
                            validOperandBType: $dialogCondBOperand.typedInput('type'),

                            valid2LogOperator: parseInt($dialogCond2LogOperator.val()),
                            valid2LogOperatorText: $dialogCond2LogOperator.find('option:selected').text(),
                            valid2OperandAValue: $dialogCond2AOperand.typedInput('value'),
                            valid2OperandAType: $dialogCond2AOperand.typedInput('type'),
                            valid2Operator: $dialogCond2AOperator.val(),
                            valid2OperatorText: $dialogCond2AOperator.find('option:selected').text(),
                            valid2OperandBValue: $dialogCond2BOperand.typedInput('value'),
                            valid2OperandBType: $dialogCond2BOperand.typedInput('type')
                        };
                    }
                    /**
                     * save the data of the rule back
                     */
                    function _dialogSaveData() {
                        const data = _dialogGetData();
                        data.description = getRuleDescription(node, selFields, data);
                        $dialogDataRow.data('ruleData', JSON.stringify(data));
                        $('#rule-name-'+dialogDataIndex).text(data.name || 'rule ' + (dialogDataIndex + 1));
                        $('#rule-description-'+dialogDataIndex).html(data.description);
                        resizeContainer();
                    }
                    // #endregion dialogload & save
                    // #endregion dialog
                }; // setup
                $.getScript('sun-position/js/htmlglobal.js')
                    .done((_data, _textStatus,  _bmvfj) => {
                        try {
                            setup(node);
                        } catch (err) {
                            console.log("failed to setup editor"); // eslint-disable-line
                            console.log(err); // eslint-disable-line
                            console.log(err.stack); // eslint-disable-line
                        }
                    })
                    .fail((jqxhr, settings, exception) => {
                        console.log("failed to load htmlglobal.js"); // eslint-disable-line
                        console.log(exception); // eslint-disable-line
                        console.log(exception.stack); // eslint-disable-line
                    });
            },
            oneditsave() {
                const node = this;
                node.rules = saveRules($('#node-input-rule-container').editableList('items'));

                const overwriteExpire = parseFloat($('#time-control-overwriteExpire').val());
                if (isNaN(overwriteExpire) || overwriteExpire === '' || overwriteExpire === 0) {
                    $('#node-input-overwriteExpire').val('');
                } else {
                    let val = overwriteExpire * parseFloat($('#time-control-overwriteExpire-multiplier').val());
                    if (val < 1000) {
                        val = 1000;
                    }
                    $('#node-input-overwriteExpire').val(val);
                }

                const smoothTime = parseFloat($('#time-control-smoothTime').val());
                if (isNaN(smoothTime) || smoothTime === '' || smoothTime === 0) {
                    $('#node-input-smoothTime').val('');
                } else {
                    $('#node-input-smoothTime').val(smoothTime * parseFloat($('#time-control-smoothTime-multiplier').val()));
                }
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditcancel() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditdelete() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            }
        });
    })();</script>

<script type="text/html" data-template-name="blind-control">
    <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" class="row-full-width" id="node-input-positionConfig">
    </div>
    <hr>
    <!-- blind ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
        <span><i class="fa fa-window-maximize"></i> <span data-i18n="[html]blind-control.text.blind" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindIncrement">
        <label for="node-input-blindIncrement"><i class="fa fa-plus-circle"></i> <span data-i18n="blind-control.label.blindIncrement"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-blindIncrement" data-i18n="[placeholder]blind-control.placeholder.blindIncrement"/>
    </div>
    <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindOpenPos">
        <label for="node-input-blindOpenPos"><i class="fa fa-chevron-circle-up"></i> <span data-i18n="blind-control.label.blindOpenPos"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-blindOpenPos" data-i18n="[placeholder]blind-control.placeholder.blindOpenPos"/>
    </div>
    <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindClosedPos">
        <label for="node-input-blindClosedPos"><i class="fa fa-chevron-circle-down"></i> <span data-i18n="blind-control.label.blindClosedPos"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-blindClosedPos" data-i18n="[placeholder]blind-control.placeholder.blindClosedPos"/>
    </div>
    <hr>
    <!-- time ######################################################################## -->
    <div class="is-to-show-initially">
        <span><i class="fa fa-list"></i> <span data-i18n="[html]blind-control.text.time"></span></span></span>
        <div class="form-row node-input-rule-container-row row-full-width">
            <ol id="node-input-rule-container"></ol>
            <button type="button" id="node-button-add" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.btnAdd"></span></button> &nbsp;
            <button type="button" id="node-button-clear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="blind-control.label.btnClear"></span></button> &nbsp;
            <button type="button" id="node-button-sort" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnSort" style="margin-top: 4px;"><i class="fa fa-sort-amount-asc"></i> <span data-i18n="blind-control.label.btnSort"></span></button>
        </div>
    </div>

    <div class="form-row block-noindent is-to-show-initially">
        <span data-i18n="[html]blind-control.text.blindLevelDefault" class="row-full-width"></span>
    </div>
    <div class="form-row block-noindent is-to-show-initially" data-i18n="[title]blind-control.placeholder.blindLevelDefault">
        <label for="node-input-blindPosDefault"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelDefault"></span></label>
        <input type="text" id="node-input-blindPosDefault" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelDefault"/>
        <input type="hidden" id="node-input-blindPosDefaultType">
    </div>
    <hr>
    <!-- overwrite blind ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
        <span><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]blind-control.text.overwrite" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row row-overwriteValue block-indent1" data-i18n="[titel]blind-control.placeholder.overwriteExpire">
        <label for="time-control-overwriteExpire"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.overwriteExpire"></span></label>
        <input type="text" class="spinner-time" id="time-control-overwriteExpire" data-i18n="[placeholder]blind-control.placeholder.overwriteExpire" value=""/>
        <select id="time-control-overwriteExpire-multiplier" class="node-input-multiplier">
            <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
            <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
            <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
        </select>
        <input type="hidden" id="node-input-overwriteExpire">
    </div>
    <hr>
    <!-- sun ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
            <span><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]blind-control.text.overwrite" class="row-full-width"></span></span></span>
            <span data-i18n="[html]blind-control.text.sunControlMode" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row block-noindent" ata-i18n="[title]blind-control.placeholder.sunControlMode">
        <label for="node-input-sunControlMode"><i class="fa fa-play-circle"></i> <span data-i18n="blind-control.label.sunControlMode"></span></label>
        <select id="node-input-sunControlMode" class="row-full-width">
            <option value="0" data-i18n="[html]blind-control.label.sunControlOff"></option>
            <option value="1" data-i18n="[html]blind-control.label.sunControlMaximize"></option>
            <option value="2" data-i18n="[html]blind-control.label.sunControlRestrict"></option>
        </select>
    </div>
    <div class="form-row form-row-sunControlRestriction block-noindent">
        <span data-i18n="[html]blind-control.text.sunControlRestriction" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlMaximization block-noindent">
        <span data-i18n="[html]blind-control.text.sunControlMaximization" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <hr class="form-row-sunControlActive" >
    <!-- window ######################################################################## -->
    <div class="form-row form-row-sunControlActive block-noindent">
        <span data-i18n="[html]blind-control.text.windowAzimuth" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowAzimuthStart">
        <label for="node-input-windowAzimuthStart"><i class="fa fa-compass fa-spin"></i> <span data-i18n="blind-control.label.windowAzimuthStart"></span></label>
        <input type="text" class="spinner-angle row-full-width" id="node-input-windowAzimuthStart" data-i18n="[placeholder]blind-control.placeholder.windowAzimuthStart"/>
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowAzimuthEnd">
        <label for="node-input-windowAzimuthEnd"><i class="fa fa-compass fa-spin"></i> <span data-i18n="blind-control.label.windowAzimuthEnd"></span></label>
        <input type="text" class="spinner-angle row-full-width" id="node-input-windowAzimuthEnd" data-i18n="[placeholder]blind-control.placeholder.windowAzimuthEnd"/>
    </div>
    <div class="form-row form-row-sunControlRestriction block-noindent">
        <span data-i18n="[html]blind-control.text.windowPos" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowTop">
        <label for="node-input-windowTop"><i class="fa fa-arrow-up"></i> <span data-i18n="blind-control.label.windowTop"></span></label>
        <input type="text" class="spinner-noLimit row-full-width" id="node-input-windowTop" data-i18n="[placeholder]blind-control.placeholder.windowTop"/>
    </div>
    <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowBottom">
        <label for="node-input-windowBottom"><i class="fa fa-arrow-down"></i> <span data-i18n="blind-control.label.windowBottom"></span></label>
        <input type="text" class="spinner-noLimit row-full-width" id="node-input-windowBottom" data-i18n="[placeholder]blind-control.placeholder.windowBottom"/>
    </div>
     <!-- sun ######################################################################## -->
     <div class="form-row form-row-sunControlRestriction block-indent1-noadd">
        <span data-i18n="[html]blind-control.text.sunCtrlLoF" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunFloorLength">
        <label for="node-input-sunFloorLength"><i class="fa fa-arrows-h"></i> <span data-i18n="blind-control.label.sunFloorLength"></span></label>
        <input type="text" class="spinner-noLimit row-full-width" id="node-input-sunFloorLength" data-i18n="[placeholder]blind-control.placeholder.sunFloorLength"/>
    </div>
    <div class="form-row form-row-sunControlRestriction block-indent1-noadd">
        <span data-i18n="[html]blind-control.text.sunCtrlRestrict" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunMinAltitude">
        <label for="node-input-sunMinAltitude"><i class="fa fa-arrows-v"></i> <span data-i18n="blind-control.label.sunMinAltitude"></span></label>
        <input type="text" class="spinner-altitude row-full-width" id="node-input-sunMinAltitude" data-i18n="[placeholder]blind-control.placeholder.sunMinAltitude"/>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunMinDelta">
        <label for="node-input-sunMinDelta"><i class="fa fa-star-half"></i> <span data-i18n="blind-control.label.sunMinDelta"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-sunMinDelta" data-i18n="[placeholder]blind-control.placeholder.sunMinDelta"/>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.smoothTime">
        <label for="time-control-smoothTime"><i class="fa fa-calculator"></i> <span data-i18n="blind-control.label.smoothTime"></span></label>
        <input type="text" class="spinner-time" id="time-control-smoothTime" data-i18n="[placeholder]blind-control.placeholder.smoothTime" value=""/>
        <select id="time-control-smoothTime-multiplier" class="node-input-multiplier">
            <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
            <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
            <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
        </select>
        <input type="hidden" id="node-input-smoothTime">
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindLevelMin">
        <label for="node-input-blindPosMin"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelMin"></span></label>
        <input type="text" id="node-input-blindPosMin" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelMin"/>
        <input type="hidden" id="node-input-blindPosMinType">
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindLevelMax">
        <label for="node-input-blindPosMax"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelMax"></span></label>
        <input type="text" id="node-input-blindPosMax" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelMax"/>
        <input type="hidden" id="node-input-blindPosMaxType">
    </div>
    <hr class="form-row-sunControlActive" >
    <!-- oversteering ######################################################################## -->
    <div class="form-row form-row-sunControlActive block-noindent">
        <span data-i18n="[html]blind-control.text.oversteer" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlActive block-noindent" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteerValue"> <i class="fa fa-thermometer-three-quarters fa-fw"></i> </i> <span data-i18n="blind-control.label.oversteerValue"></span></label>
        <input type="text" id="node-input-oversteerValue" class="" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteerValueType">
        <select id="node-input-oversteerCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row row-oversteerThreshold is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.oversteerThreshold">
        <label for="node-input-oversteerThreshold"><i class="fa fa-compress"></i> <span data-i18n="blind-control.label.oversteerThreshold"></span></label>
        <input type="text" id="node-input-oversteerThreshold" data-i18n="[placeholder]blind-control.placeholder.oversteerThreshold"/>
        <input type="hidden" id="node-input-oversteerThresholdType">
    </div>
    <div class="form-row row-oversteerBlindPos is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteerBlindPos"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.oversteerBlindPos"></span></label>
        <input type="text" id="node-input-oversteerBlindPos" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteerBlindPosType">
    </div>
    <div class="form-row row-oversteer2Value is-initial-hidden block-noindent" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer2Value"> <i class="fa fa-cloud fa-fw"></i> <span data-i18n="blind-control.label.oversteer2Value"></span></label>
        <input type="text" id="node-input-oversteer2Value" class="" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer2ValueType">
        <select id="node-input-oversteer2Compare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row row-oversteer2Threshold is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.oversteerThreshold">
        <label for="node-input-oversteer2Threshold"><i class="fa fa-compress"></i> <span data-i18n="blind-control.label.oversteer2Threshold"></span></label>
        <input type="text" id="node-input-oversteer2Threshold" data-i18n="[placeholder]blind-control.placeholder.oversteerThreshold"/>
        <input type="hidden" id="node-input-oversteer2ThresholdType">
    </div>
    <div class="form-row row-oversteer2BlindPos is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer2BlindPos"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.oversteer2BlindPos"></span></label>
        <input type="text" id="node-input-oversteer2BlindPos" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer2BlindPosType">
    </div>
    <div class="form-row row-oversteer3Value is-initial-hidden block-noindent" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer3Value"> <i class="fa fa-tint fa-fw"></i> <span data-i18n="blind-control.label.oversteer3Value"></span></label>
        <input type="text" id="node-input-oversteer3Value" class="" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer3ValueType">
        <select id="node-input-oversteer3Compare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row row-oversteer3Threshold is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.oversteerThreshold">
        <label for="node-input-oversteer3Threshold"><i class="fa fa-compress"></i> <span data-i18n="blind-control.label.oversteer3Threshold"></span></label>
        <input type="text" id="node-input-oversteer3Threshold" data-i18n="[placeholder]blind-control.placeholder.oversteerThreshold"/>
        <input type="hidden" id="node-input-oversteer3ThresholdType">
    </div>
    <div class="form-row row-oversteer3BlindPos is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer3BlindPos"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.oversteer3BlindPos"></span></label>
        <input type="text" id="node-input-oversteer3BlindPos" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer3BlindPosType">
    </div>
    <hr>
    <!-- Enhanced ######################################################################## -->
    <div class="form-row block-noindent" data-i18n="[title]blind-control.placeholder.outputs">
        <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="blind-control.label.outputs"></span></label>
        <select id="node-input-outputs" class="row-full-width">
            <option value="1" data-i18n="blind-control.label.singleOutput"></option>
            <option value="2" data-i18n="blind-control.label.splitOutput"></option>
        </select>
    </div>
    <hr>
    <!-- End ######################################################################## -->
    <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
    </div>
    <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" class="row-full-width" data-i18n="[placeholder]node-red:common.label.name"/>
    </div>
    <div class="form-tips is-to-show-initially">
        <span data-i18n="[html]blind-control.tips.sunPosControl" style="word-wrap:break-word;"></span>
    </div>

    <!-- DIALOG ######################################################################## -->
    <div id="dialog-select-context" class="red-ui-editor" title="Select Channel and Datapoint">
        <div id="config-lookup-tree"></div>
    </div>

    <div id="dialog-edit-rule" class="red-ui-editor" title="Edit Rule">
        <div class="dialog-row">
            <label for="dlg-ip-blindctl-rule-name"><i class="fa fa-tag"></i> <span data-i18n="blind-control.label.name"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-name" class="ipalone" data-i18n="[placeholder]blind-control.placeholder.name">
        </div>
        <div class="dialog-row pt-2" id="dialog-row-condA">
            <label for="dlg-ip-blindctl-rule-condAOperand"><i class="fa fa-puzzle-piece"></i> <span data-i18n="blind-control.label.ruleCondition"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-condAOperand" class="ipMain" data-i18n="[placeholder]blind-control.placeholder.condoperand">
            <select id="dlg-ip-blindctl-rule-condAOperator" class="ipadd dlg-ip-blindctl-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-condB">
            <label for="dlg-ip-blindctl-rule-condBOperand"><i class="fa fa-ellipsis-h"></i> <span data-i18n="blind-control.label.ruleConditionThreshold"></span></label>
            <input id="dlg-ip-blindctl-rule-condBOperand" class="ipMain" type="text" data-i18n="[placeholder]blind-control.placeholder.condoperand">
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-cond2LogOperator">
            <label for="dlg-ip-blindctl-rule-cond2LogOperator"><i class="fa fa-puzzle-piece"></i> <span data-i18n="blind-control.label.ruleAndOr"></span></label>
            <select id="dlg-ip-blindctl-rule-cond2LogOperator" class="ipadd dlg-ip-blindctl-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-cond2A">
            <label for="dlg-ip-blindctl-rule-cond2AOperand"><i class="fa fa-puzzle-piece"></i> <span data-i18n="blind-control.label.ruleCondition"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-cond2AOperand" class="ipMain" data-i18n="[placeholder]blind-control.placeholder.condoperand">
            <select id="dlg-ip-blindctl-rule-cond2AOperator" class="ipadd dlg-ip-blindctl-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-cond2B">
            <label for="dlg-ip-blindctl-rule-cond2BOperand"><i class="fa fa-ellipsis-h"></i> <span data-i18n="blind-control.label.ruleConditionThreshold"></span></label>
            <input id="dlg-ip-blindctl-rule-cond2BOperand" class="ipMain" type="text" data-i18n="[placeholder]blind-control.placeholder.condoperand">
        </div>
        <div class="dialog-row pt-2" id="dialog-row-timeReg">
            <label for="dlg-ip-blindctl-rule-timeReg"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.time"></span></label>
            <select id="dlg-ip-blindctl-rule-timeReg-operator" class="ipadd dlg-ip-blindctl-rule-timeReg-operator" >
            </select>
            <input type="text" id="dlg-ip-blindctl-rule-timeReg" class="ipMain dlg-ip-blindctl-rule-timeReg" value="" data-i18n="[placeholder]blind-control.placeholder.time">
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeReg">
            <label for="dlg-ip-blindctl-rule-offset-timeReg"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-offset-timeReg"class="ipMain dlg-ip-blindctl-rule-offset-timeReg" value="" data-i18n="[placeholder]blind-control.placeholder.offset">
            <select  id="dlg-ip-blindctl-rule-multiplier-timeReg" class="ipadd dlg-ip-blindctl-rule-multiplier-timeReg" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeMin">
            <label for="dlg-ip-blindctl-rule-timeMin"><i class="fa fa-step-backward" aria-hidden="true"></i> <span data-i18n="blind-control.label.ruleTimeMin"></span></label>
            <!-- select id="dlg-ip-blindctl-rule-timeMax-operator" class="ipadd dlg-ip-blindctl-rule-timeMax-operator" >
            </select -->
            <input type="text" id="dlg-ip-blindctl-rule-timeMin" class="ipMain dlg-ip-blindctl-rule-timeMin" value="" data-i18n="[placeholder]blind-control.placeholder.time">
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeMin">
            <label for="dlg-ip-blindctl-rule-offset-timeMin"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset-timeMin"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-offset-timeMin"class="ipMain dlg-ip-blindctl-rule-offset-timeMin" value="" data-i18n="[placeholder]blind-control.placeholder.offset">
            <select  id="dlg-ip-blindctl-rule-multiplier-timeMin" class="ipadd dlg-ip-blindctl-rule-multiplier-timeMin" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeMax">
            <label for="dlg-ip-blindctl-rule-timeMax"><i class="fa fa-step-forward" aria-hidden="true"></i> <span data-i18n="blind-control.label.ruleTimeMax"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-timeMax" class="ipMain dlg-ip-blindctl-rule-timeMax" value="" data-i18n="[placeholder]blind-control.placeholder.time">
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeMax">
            <label for="dlg-ip-blindctl-rule-offset-timeMax"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset-timeMax"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-offset-timeMax"class="ipMain dlg-ip-blindctl-rule-offset-timeMax" value="" data-i18n="[placeholder]blind-control.placeholder.offset">
            <select  id="dlg-ip-blindctl-rule-multiplier-timeMax" class="ipadd dlg-ip-blindctl-rule-multiplier-timeMax" >
            </select>
        </div>
        <div class="dialog-row pt-2" id="dialog-row-level">
            <label for="dlg-ip-blindctl-rule-level"><i class="fa fa-window-maximize"></i> <span data-i18n="blind-control.label.ruleBlindLevel" ></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-level" class="ipMain" data-i18n="[placeholder]blind-control.placeholder.level">
            <select id="dlg-ip-blindctl-rule-level-operator" class="ipadd dlg-ip-blindctl-rule-level-operator" >
            </select>
        </div>
        <div class="dialog-row pt-2 block-noindent" id="dialog-row-descr">
            <label for="dlg-txt-blindctl-rule-descr" class="pb-1"><i class="fa fa-commenting-o"></i> <span data-i18n="blind-control.label.ruleDescription" ></span></label>
            <div id="dlg-txt-blindctl-rule-descr" class="pl-3" style="word-wrap:break-word;"></div>
        </div>
    </div>
</script>
<style>
    hr { width: 100% }
    .mt-0 { margin-top:0 !important; }
    .mb-0 { margin-bottom:0 !important; }
    .pt-1 { padding-top:0.5rem !important; }
    .pb-1 { padding-bottom:0.5rem !important; }
    .pl-1 { padding-left:0.5rem !important; }
    .pr-1 { padding-right:0.5rem !important; }
    .pt-2 { padding-top:1.0rem !important; }
    .pb-2 { padding-bottom:1.0rem !important; }
    .pl-2 { padding-left:1.0rem !important; }
    .pr-2 { padding-right:1.0rem !important; }
    .pt-3 { padding-top:1.25rem !important; }
    .pb-3 { padding-bottom:1.25rem !important; }
    .pl-3 { padding-left:1.25rem !important; }
    .pr-3 { padding-right:1.25rem !important; }
    .is-to-show-initially { display:none }
    .is-initial-hidden { display:none }
    .form-row-sunControlActive { display:none }
    .form-row-sunControlRestriction { display:none }
    .form-row-sunControlMaximization { display:none }
    .form-tips { width: 90% }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 2%; /* 10px; */
        width: 98%
    }
    .block-indent1-noadd {
        float: left;
        min-height: 1px;
        margin-left: 2%; /* 10px; */
        width: 98%
    }
    .input-error {
        border-color: #d6615f !important;
        background-color: #ffcccc !important;
    }

    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-indent2-noadd {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .block-noindent-noadd .ui-spinner {
        width : calc(100% - 110px);
    }
    .block-indent1-noadd .ui-spinner {
        width : calc(100% - 120px);
    }
    .block-indent2-noadd .ui-spinner {
        width : calc(100% - 130px);
    }
    .indent-time-text {
        /* text-indent:10px; */
        padding-left: 20px;
    }
    .indent-enh-text {
        padding-left: 10px;
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
    .ui-spinner input {
        border: none !important;
        width: 95% !important;
    }

    .dialog-row {
        clear: both;
        color: #555;
        margin-bottom: 5px;
    }
    .ui-dialog-rdg .ui-dialog-content-rdg {
        padding: 25px 25px 10px 25px !important;
    }
    .dialog-row label {
        display: inline-block;
        /* width: 9rem; */
        width: 25%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 label {
        /* width: 11rem; */
        width: 23%;
    }
    .dialog-row.block-indent2 label {
        /* width: 13rem; */
        width: 22%;
    }

    .dialog-row .ipalone {
        /* width: calc(90% - 9rem); */
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipMain {
        /* width: calc(60% - 9rem); */
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipadd {
        /* width: calc(20% - 9rem);*/
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }npm
    .blind-rule-mainblock {
        margin-right: 28px;
    }
    .blind-rule-name-span {
        /* font-weight: bolder; */
        width: 30%; /* width: 120px; */
        float: left;
    }
    .blind-rule-description-span {
        font-size: 10px;
        margin-left: 30%; /* margin-left: 122px; */
        margin-right: 5px;
    }
    .blind-rule-finalspan {
        top: 50%;
        position: absolute;
        right: 66px;
        margin-top: -9px;
    }
    .blind-rule-editBtn {
        top: 50%;
        position: absolute;
        right: 28px;
        margin-top: -9px !important;
    }
</style>